# role: icinga2 satellite or agent
---
- name: "Configure Icinga2 Satellite or Client"
  ansible.builtin.include_tasks: setup_cluster.yml
  args:
    apply:
      become: true
      tags:
        - service_monitoring
  when: "inventory.monitoring is defined and inventory.monitoring.master is defined"
  tags:
    - service_monitoring

- name: "Configure Icinga2 Standalone"
  ansible.builtin.include_tasks: setup_standalone.yml
  args:
    apply:
      become: true
      tags:
        - service_monitoring
  when: "inventory.monitoring is not defined or inventory.monitoring.master is not defined"
  tags:
    - service_monitoring

- name: "Mark Icinga2 instance as managed"
  become: true
  ansible.builtin.lineinfile:
    path: "/etc/icinga2/.managed"
    create: true
    regex: "^ansible"
    line: "ansible managed"
    owner: "root"
    group: "root"
    mode: "0644"
